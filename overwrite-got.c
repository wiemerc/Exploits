#include <stdio.h>
#include <time.h>

static int g_dummy = 0xbebafeca;

static void print_pwned()
{
    printf("YOU'VE BEEN PWNED!!!\n");
}

int main()
{
    // The entry for time() in the GOT lives at g_dummy - 24 (.got.plt comes right before .data)
    // so we can just overwrite the function pointer there. This can be made impossible with
    // read-only relocations (RELRO), which can be enabled with `-Wl,-z,relro,-z,now`.
    // See the following articles for details:
    // https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/
    // https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html
    // https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-di-frederico.pdf
    void (**p_func)() = (void (**)()) (((char *) &g_dummy) - 24);
    *p_func = print_pwned;

    printf("now = %ld\n", time(NULL));
    return 0;
}

